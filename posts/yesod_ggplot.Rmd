---
title: "A R graphic in a Yesod app"
author: "St√©phane Laurent"
date: '2023-12-02'
tags: R, haskell
rbloggers: yes
output:
  md_document:
    variant: markdown
    preserve_yaml: true
  html_document:
    highlight: kate
    keep_md: no
highlighter: pandoc-solarized
---

Yesod is a web framework for Haskell. In this post I show how to do a Yesod 
application allowing to upload some data from a CSV or a XLSX file and to 
display a R graphic representing two selected columns of the data.

Here is the directory content of the application:

```
|   .dir-locals.el
|   client_session_key.aes
|   package.yaml
|   README.md
|   routes.yesodroutes
|   stack.yaml
|   
+---app
|       Main.hs
|       
+---src
|       Application.hs
|       Foundation.hs
|       GGplot.hs
|       Home.hs
|       
\---static
    +---bootstrap-5.3.2
    |   +---css
    |   |       bootstrap.min.css
    |   |       bootstrap.min.css.map
    |   |       
    |   \---js
    |           bootstrap.bundle.min.js
    |           bootstrap.bundle.min.js.map
    |           
    +---DataTables-1.13.8
    |   |   datatables.min.css
    |   |   datatables.min.js
    |   |   
    |   \---images
    |           sort_asc.png
    |           sort_asc_disabled.png
    |           sort_both.png
    |           sort_desc.png
    |           sort_desc_disabled.png
    |           
    +---images
    |       haskell.png
    |       
    +---jQuery
    |       jquery-3.7.1.min.js
    |       
    +---PapaParse
    |       papaparse.min.js
    |       
    +---R
    |       ggplotXY.R
    |       
    \---SheetJS
            xlsx.core.min.js
            xlsx.core.min.map
```

I'm using **bootstrap** for the style, **DataTables** to display a nice table 
of the data, **PapaParse** to parse the uploaded CSV file to a JSON object, and
**SheetJS** to convert the uploaded XLSX file to CSV data, which can then be 
parsed to a JSON object with **PapaParse**.

[Hamlet](https://www.yesodweb.com/book/shakespearean-templates) is a HTML 
templating language developed for Yesod applications. Below is the Hamlet code 
of the application. I use a Bootstrap modal to display errors if there are.

```html
<body>
  $# BOOTSTRAP MODAL -----------------------------------------------------------
  <div #myModal .modal .fade aria-hidden aria-labelledby=myModalLabel tabindex=-1>
    <div .modal-dialog .modal-dialog-centered>
      <div .modal-content>
        <div .modal-header>
            <h1 .modal-title .fs-5>
        <div .modal-body>
            <span #message>
        <div .modal-footer>
            <button type=button .btn .btn-secondary data-bs-dismiss=modal>Close
  $# HASKELL LOGO --------------------------------------------------------------
  <img src=./static/images/haskell.png style=float:right;margin:5px;width:50px;>
  $# ---------------------------------------------------------------------------
  <div .container-fluid>
    $# TABS --------------------------------------------------------
    <ul .nav .nav-tabs role=tablist>
      <li .nav-item role=presentation>
        <button #data-tab .nav-link .active data-bs-toggle=tab data-bs-target=#data-tab-pane type=button role=tab aria-controls=data-tab-pane aria-selected=true>Data
      <li .nav-item role=presentation>
        <button #plot-tab .nav-link data-bs-toggle=tab data-bs-target=#plot-tab-pane type=button role=tab aria-controls=plot-tab-pane aria-selected=false>Plot
    $# TABS CONTENTS -----------------------------------------------------------
    <div #tabContent .tab-content>
      $# DATA TAB --------------------------------------------------------------
      <div #data-tab-pane .tab-pane .fade .show .active role=tabpanel aria-labelledby=data-tab tabindex=0>
        <div .row>
          $# SIDEBAR -----------------------------------------------------------
          <div .col-4>
            <div .card .text-bg-dark tabindex=-1 aria-labelledby=sidebarDataTitle>
              <div .card-body>
                <h5 #sidebarDataTitle .card-title>Upload data
                <h6 .card-text>Upload a CSV file or a XLSX file.
                <p .card-text style=font-style:italic;>If you upload a XLSX file, the data from the first sheet will be extracted.
                <input #file type=file .form-control .btn .btn-info>
          $# TABLE -------------------------------------------------------------
          <div .col-8>
            <table #table .table-striped .table-bordered .table-hover>
              <thead>
                <tr role=row>
              <tbody>
      $# PLOT TAB --------------------------------------------------------------
      <div #plot-tab-pane .tab-pane .fade role=tabpanel aria-labelledby=plot-tab tabindex=0>
        <div .row>
          $# SIDEBAR -----------------------------------------------------------
          <div .col-4>
            <div .sidebar .card .text-bg-dark tabindex=-1 aria-labelledby=sidebarPlotTitle>
              <div .card-body>
                <div .sidebar-header>
                  <h5 #sidebarPlotTitle .card-title>Plot
                <div .sidebar-body>
                  <fieldset #selectXY style=display:none;>
                    <label for=selX>Select the <em>x</em> column
                    <select .form-control #selX style=overflow-y:auto;>
                    <br>
                    <label for=selY>Select the <em>y</em> column
                    <select .form-control #selY style=overflow-y:auto;>
            $# SPINNER ---------------------------------------------------------
            <div #spinner .spinner-border .m-5 role=status style=display:none>
                <span .visually-hidden>Loading...
          $# PLOT --------------------------------------------------------------
          <div .col-8>
            <img #plot width=100% height=400px>
```

The interface has two tabs: one to upload and display the data, and the other 
one to select two columns and display the graphic.

The JavaScript function below will be called when the user uploads a file. 
The file can be either a CSV file or a XLSX file. If this is a XLSX file, 
then its content will be converted to CSV data before calling this function.
This function firstly converts the CSV data to a JSON object, then it fills the 
table with the data and the `x` and `y` dropdown lists with the column names, 
and then it defines the behavior of the application.

``` {.js .numberLines}
function papaParse(csv) {
  Papa.parse(csv, {
    header: true,
    skipEmptyLines: true,
    dynamicTyping: true,
    complete: function(results) {
      if(results.errors.length != 0) {
        alert("Something is wrong with this CSV file.");
        console.log("Errors:", results.errors);
        throw new Error("Something is wrong with this CSV file.");
      }
      let dataframe = results.data;
      let colNames = results.meta.fields;
      // Fill the table --------------------------------------------------------
      let headers = "";
      for(let colname of colNames) {
        headers += "<th>" + colname + "</th>";
      }
      $("#table thead tr").append(headers);
      let columns = [];
      for(let colname of colNames) {
        columns.push({ data: colname });
      }
      $("#table").DataTable({
        data: results.data,
        columns: columns
      });
      // the dataframe is an array of objects like:
      //   [{A: a1, B: b1, ...}, {A: a2, B: b2, ...}, ...]
      // we transform it to this object:
      //   {A: [a1, a2, ...], B: [b1, b2, ...], ...}
      let dfx = {}; // for x, we convert every entry to a string
      let dfy = {}; // for y, we don't convert anything
      for(let colname of colNames) {
        let columnx = [];
        let columny = [];
        for(let j = 0; j < dataframe.length; j++) {
          let entry = dataframe[j][colname];
          columnx.push(entry.toString());
          columny.push(entry);
        }
        dfx[colname] = columnx;
        dfy[colname] = columny;
      }
      // Fill the x & y dropdowns ----------------------------------------------
      let $selsXY = $("#selX, #selY");
      let ncolumns = colNames.length;
      let size = ncolumns < 5 ? ncolumns : 5;
      $selsXY.attr("size", size);
      $(colNames).each(function(idx, item) {
        if(item != "") {
          $selsXY.append($("<option>").attr("value", idx).text(item));
        }
      });
      // Set x to the first column and y to the second one ---------------------
      let selX = document.querySelector("#selX");
      let selY = document.querySelector("#selY");
      selX.value = "0";
      selY.value = "1";
      $("#selectXY").show();
      // Initial plot ----------------------------------------------------------
      let myModalEl = document.getElementById("myModal");
      let myModal = new bootstrap.Modal(myModalEl);
      let messageEl = myModalEl.querySelector("#message");
      let titleEl = myModalEl.querySelector(".modal-title");
      let $selX = $("#selX");
      let $selY = $("#selY");
      plot($selX, $selY, dfx, dfy, colNames, titleEl, messageEl, myModal);
      // Plot on change x or y -------------------------------------------------
      $selsXY.on("change", function() {
        plot($selX, $selY, dfx, dfy, colNames, titleEl, messageEl, myModal);
      });
      // Plot on resize --------------------------------------------------------
      $(window).on("resize", function() {
        plot($selX, $selY, dfx, dfy, colNames, titleEl, messageEl, myModal);
      });
    }
  });
}
```
